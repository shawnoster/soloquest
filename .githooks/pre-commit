#!/bin/bash
# Pre-commit hook: ensure code quality before committing
set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# 1. Format check
echo "ğŸ“ Formatting code..."
if ! uv run ruff format wyrd tests; then
    echo "âŒ Formatting failed"
    exit 1
fi
echo "âœ… Formatting passed"
echo ""

# 2. Lint check
echo "ğŸ” Linting code..."
if ! uv run ruff check wyrd tests; then
    echo "âŒ Linting failed"
    exit 1
fi
echo "âœ… Linting passed"
echo ""

# 3. Get baseline coverage (if exists)
baseline_coverage=""
if [ -f .coverage ]; then
    baseline_coverage=$(uv run python -m coverage report --format=total 2>/dev/null || echo "")
fi

# 4. Run tests with coverage
echo "ğŸ§ª Running tests with coverage..."
if ! uv run python -m pytest; then
    echo "âŒ Tests failed"
    exit 1
fi
echo "âœ… Tests passed"
echo ""

# 5. Check coverage hasn't dropped more than 1%
if [ -n "$baseline_coverage" ]; then
    new_coverage=$(uv run python -m coverage report --format=total)
    baseline_int=$(printf "%.0f" "$baseline_coverage")
    new_int=$(printf "%.0f" "$new_coverage")
    diff=$((new_int - baseline_int))

    echo "ğŸ“Š Coverage: ${baseline_coverage}% â†’ ${new_coverage}% (${diff:+"+"}${diff}%)"

    if [ "$diff" -lt -1 ]; then
        echo "âŒ Coverage dropped by more than 1% (${diff}%)"
        echo "   Baseline: ${baseline_coverage}%"
        echo "   Current:  ${new_coverage}%"
        exit 1
    fi
    echo "âœ… Coverage check passed"
else
    new_coverage=$(uv run python -m coverage report --format=total)
    echo "ğŸ“Š Coverage: ${new_coverage}% (no baseline to compare)"
fi

echo ""
echo "âœ¨ All pre-commit checks passed!"
